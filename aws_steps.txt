
Local Spin up the instance
==========================
cd ~/Documents

source ~/.bash_profile 

aws --region=eu-west-1 ec2 describe-spot-price-history --instance-types  p3.2xlarge --start-time=$(date +%s) --product-descriptions="Linux/UNIX" --query 'SpotPriceHistory[*].{az:AvailabilityZone, price:SpotPrice}' --availability-zone eu-west-1a

aws ec2 run-instances --image-id ami-0f5ebd171c26abc61 --instance-type p3.2xlarge --security-group-ids sg-09ceb02f960da25fa  --associate-public-ip-address --instance-market-options file://spot-options.json --key-name darraghaws  --placement AvailabilityZone=eu-west-1a

aws ec2 describe-instances | grep ec2

# Manually attach the volume
ssh -i "darraghaws.pem" ubuntu@ec2-46-137-24-16.eu-west-1.compute.amazonaws.com


Remote 
===================
source activate pytorch_latest_p36


# Mount the volume
sudo mkdir /data
sudo mount /dev/xvdf /data
sudo cp /etc/fstab /etc/fstab.orig
sudo lsblk -o +UUID

# Add for restart
sudo vim /etc/fstab
# Add a line like 
# UUID=aebf131c-6957-451e-8d34-ec978d9581ae  /data  xfs  defaults,nofail  0  2

# Installs
sudo apt-get update -y
sudo apt-get install -y libturbojpeg
git config --global credential.helper store # so we only need to enter credentials once
cd /data/rsnastr
pip install -r requirements.txt 

# conda if you want it
wget https://repo.anaconda.com/archive/Anaconda3-2020.07-Linux-x86_64.sh
bash Anaconda3-2020.07-Linux-x86_64.sh
source ~/.bashrc

# Install gdcm (aaaarrrgghhh!!)
cd ~
sudo apt-get update
sudo apt install -y python-vtk6 libvtk6-dev cmake-curses-gui checkinstall swig libpython3.6-dev
mkdir gdcm && cd gdcm && git clone --branch release git://git.code.sf.net/p/gdcm/gdcm
mkdir build && cd build
sudo cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_FLAGS=-fPIC -DCMAKE_CXX_FLAGS=-fPIC -DGDCM_BUILD_SHARED_LIBS:BOOL=ON -DGDCM_WRAP_PYTHON=ON PYTHON_EXECUTABLE=/usr/local/bin/python3.6 PYTHON_INCLUDE_DIR=/usr/local/lib/python3.6/site-packages/ GDCM_BUILD_SHARED_LIBS=ON GDCM_USE_VTK=ON ~/gdcm/gdcm
sudo cmake --build . --target install

sudo cp /usr/local/lib/gdcm.py /usr/local/lib/python3.6/dist-packages/.
sudo cp /usr/local/lib/gdcmswig.py /usr/local/lib/python3.6/dist-packages/.
sudo cp /usr/local/lib/_gdcmswig.so /usr/local/lib/python3.6/dist-packages/.
sudo cp /usr/local/lib/libgdcm* /usr/local/lib/python3.6/dist-packages/.
sudo ldconfig